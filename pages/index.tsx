import Head from 'next/head';
import { useEffect, useState } from 'react';
import styles from '../styles/Home.module.css';
import useSWR from 'swr';

import Reading from '../components/Reading/Reading';
import Wind from '../components/Wind/Wind';
import { CurrentConditions, MainSensorData, SensorType } from '../models/weatherlink';

const fetcher = (input: RequestInfo | URL, init?: RequestInit) => fetch(input, init).then(res => res.json());

const useSensors = (): { currentConditions?: CurrentConditions; isLoading: boolean; isError: boolean } => {
  const { data, error } = useSWR<CurrentConditions>('/api/weatherlink', fetcher);

  return {
    currentConditions: data,
    isLoading: !error && !data,
    isError: error
  };
};

export default function Home() {
  const { currentConditions, isLoading, isError } = useSensors();
  const [mainSensor, setMainSensor] = useState<MainSensorData | null>(null);

  useEffect(() => {
    if (currentConditions) {
      setMainSensor(
        (currentConditions.sensors.find(sensor => sensor.sensor_type === SensorType.MAIN)?.data[0] as MainSensorData) ??
          null
      );
      console.log(mainSensor);
    }
  }, [currentConditions, mainSensor]);

  return (
    <div className={styles.container}>
      <Head>
        <title>#aq Weather</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <h1>Current Conditions in #aq</h1>

      {mainSensor ? (
        <div className={styles.main}>
          <Reading title="Temp" value={`${mainSensor.temp}°`} />
          <Reading title="Feels Like" value={`${mainSensor.heat_index}°`} />
          <Reading title="Humidity" value={`${mainSensor.hum}%`} />
          <Reading title="Wind">
            <Wind windData={mainSensor} />
          </Reading>
        </div>
      ) : (
        <h1>Hang Tight</h1>
      )}
    </div>
  );
}
