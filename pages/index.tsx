import Head from 'next/head';
import useSWR from 'swr';
import { CardHeader, Condition, CurrentTemp, Measurement, UVIndex, Wind } from '../components/Card';

import { APIRoute, getPath, Observations, Response } from '../models/api';
import styles from '../styles/Home.module.css';

const fetcher = (key: string) => fetch(key).then(res => res.json());

const useObservations = (): { observations?: Response<Observations>; isLoading: boolean; isError: boolean } => {
  const { data, error } = useSWR<Response<Observations>>(getPath(APIRoute.CURRENT), fetcher);

  return {
    observations: data,
    isLoading: !error && !data,
    isError: error
  };
};

export default function Home() {
  const { observations, isLoading, isError } = useObservations();

  return (
    <div className={styles.container}>
      <Head>
        <title>#aq Weather</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <div style={{ display: 'flex', justifyContent: 'center', padding: '2rem 0rem' }}>
        <img src="skylines/boston.svg" style={{ height: '8rem', objectFit: 'scale-down' }}></img>
      </div>
      {observations ? (
        !isError && observations.data ? (
          <>
            <article
              style={{
                background: '#ffffff',
                margin: '1rem 0rem',
                borderRadius: '2px',
                boxShadow: '0px 0.25rem 0.5rem rgba(0, 0, 0, .15)'
              }}
            >
              <CardHeader lastUpdatedTime={observations.latestReadTime * 1_000}></CardHeader>
              <div
                style={{
                  display: 'flex',
                  flexWrap: 'wrap',
                  alignItems: 'center',
                  padding: '0.5rem 1rem'
                }}
              >
                <div style={{ flexGrow: '1', maxWidth: '24.5rem' }}>
                  <CurrentTemp observations={observations}></CurrentTemp>
                  <Condition condition={observations.data.nws?.textDescription}></Condition>
                </div>
                <div style={{ display: 'flex', flexWrap: 'wrap', flexBasis: '37.5rem' }}>
                  <Wind wind={observations.data.wl?.wind}></Wind>
                  <UVIndex epaData={observations.data.epa}></UVIndex>
                  {/* <Measurement
                    value={String(
                      observations.data.epa?.hourlyForecast.reduce(epaHourlyForecastReducer).uvIndex ?? '–'
                    )}
                    secondaryValue={
                      observations.data.epa?.hourlyForecast.reduce(epaHourlyForecastReducer).uvLevelName ?? '–'
                    }
                    label="UV Index"
                  /> */}
                  {observations.data.airnow?.observations?.length ? (
                    <Measurement
                      value={String(observations.data.airnow.observations[0].aqi ?? '–')}
                      secondaryValue={observations.data.airnow.observations[0].aqiLevelName ?? '–'}
                      label={`Air Quality (${observations.data.airnow.observations[0].pollutant})`}
                    />
                  ) : (
                    <Measurement value={`–`} secondaryValue={`–`} label="Air Quality" />
                  )}

                  <Measurement value={`${Math.round(observations.data.wl?.humidity ?? 0)}%`} label="Humidity" />
                  <Measurement
                    value={`${observations.data.wl?.pressure.atSeaLevel?.toFixed(2) ?? '–'} in ${
                      observations.data.wl?.pressure.trend ? (observations.data.wl.pressure.trend > 0 ? '↑' : '↓') : '→'
                    }`}
                    label="Pressure"
                  />
                  <Measurement
                    value={`${observations.data.wl?.rainfall.last24Hrs?.toFixed(2) ?? '–'} in`}
                    label="Last 24hr Rainfall"
                  />
                </div>
              </div>
            </article>
          </>
        ) : (
          <>
            <h1>Something went wrong :(</h1>
            <br />
            {observations?.errors.map(error => (
              <h3 key={error}>{error}</h3>
            ))}
          </>
        )
      ) : (
        <h1>Loading...</h1>
      )}
    </div>
  );
}
